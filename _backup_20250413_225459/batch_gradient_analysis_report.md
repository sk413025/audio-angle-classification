# 批次梯度分析實驗報告

## 實驗背景與目的

本實驗旨在應用批次梯度分析工具，檢視深度學習模型在訓練過程中的梯度行為。通過分析不同批次間的梯度一致性，我們可以評估：

1. 訓練過程中梯度方向的穩定性
2. 可能存在的數據問題或衝突
3. 批次大小的適合度
4. 模型訓練的健康程度

批次梯度噪聲尺度（Gradient Noise Scale, GNS）是衡量梯度一致性的關鍵指標：

```
GNS = E[∥∇L(B)-∇L(D)∥²] / ∥∇L(D)∥²
```

其中 B 是小批次，D 是整個數據集。GNS 值越低，表示不同批次梯度方向越一致，通常代表梯度估計的穩定性較高。

## 實驗設置

### 數據集
- 材質：plastic
- 頻率：3000Hz
- 樣本數：54個樣本
- 分類數：6個角度類別（deg000, deg036, deg072, deg108, deg144, deg180）

### 模型與訓練
- 使用凍結的ResNet骨幹，只訓練分類器層和prompt模板
- 訓練持續30個epochs
- 每5個epochs保存一次檢查點
- 設備：MPS（Apple Silicon）

## 分析結果

### GNS趨勢分析

對所有6個檢查點的GNS值測量結果：

| Epoch | GNS值 |
|-------|-------|
| 5     | 0.000015 |
| 10    | 0.000015 |
| 15    | 0.000022 |
| 20    | 0.000042 |
| 25    | 0.000066 |
| 30    | 0.000038 |

#### GNS隨訓練進度變化趨勢圖

![GNS趨勢圖](report_images/gns_vs_epoch_plastic_3000hz.png)

從趨勢圖可以清楚看到，GNS值雖然在訓練過程中有小幅上升，但整體維持在極低水平，表明梯度方向非常一致。

### 批次梯度方向t-SNE視覺化

各個訓練階段的梯度方向t-SNE視覺化結果如下：

#### Epoch 5 的梯度方向t-SNE視覺化

![Epoch 5 t-SNE](report_images/gradient_directions_tsne_epoch_5.png)

#### Epoch 15 的梯度方向t-SNE視覺化

![Epoch 15 t-SNE](report_images/gradient_directions_tsne_epoch_15.png)

#### Epoch 30 的梯度方向t-SNE視覺化

![Epoch 30 t-SNE](report_images/gradient_directions_tsne_epoch_30.png)

從上述t-SNE視覺化可以觀察到，即使在不同訓練階段，批次梯度方向都呈現出緊湊的聚類，表明不同批次之間的梯度方向高度一致。

### 批次梯度相似度矩陣

各個訓練階段的梯度相似度矩陣如下：

#### Epoch 5 的梯度相似度矩陣

![Epoch 5 相似度矩陣](report_images/gradient_similarities_epoch_5.png)

#### Epoch 15 的梯度相似度矩陣

![Epoch 15 相似度矩陣](report_images/gradient_similarities_epoch_15.png)

#### Epoch 30 的梯度相似度矩陣

![Epoch 30 相似度矩陣](report_images/gradient_similarities_epoch_30.png)

相似度矩陣中的明亮區域表示不同批次間的梯度方向高度相似。從上述矩陣可以看出，大多數批次間的梯度方向都呈現較高的正相關，沒有明顯的負相關區域。

## 結果解讀

### GNS值分析

- **極低的GNS值**：所有檢查點的GNS值均遠低於0.01（範圍在0.000015-0.000066之間），表明不同批次間的梯度方向極為一致。
- **輕微上升趨勢**：從第5個epoch到第25個epoch，GNS值有小幅上升，但在第30個epoch有所下降。
- **整體穩定性**：即使在上升階段，GNS值始終保持在非常低的水平，表明訓練過程中梯度估計極為穩定。

### t-SNE視覺化分析

觀察不同epoch的t-SNE圖，可以發現：
- 梯度方向呈現緊湊的聚類，表明不同批次間梯度方向高度一致
- 沒有明顯的離群點或分離的聚類，表明不存在明顯的衝突數據
- 從Epoch 5到Epoch 30，聚類形態變化不大，表明模型訓練過程中梯度方向穩定

### 相似度矩陣分析

各epoch的相似度矩陣顯示：
- 整體呈現高亮度區域，表明大多數批次間梯度方向高度相似
- 沒有明顯的負相關區域，表明不存在方向相反的梯度衝突
- 隨著訓練進行，相似度矩陣的整體亮度有些微變化，但始終保持在較高水平

## 結論與建議

### 數據質量評估

- **高質量數據**：極低的GNS值和一致的梯度方向表明數據標註質量高，不存在明顯的衝突或問題。
- **均衡的分布**：t-SNE視覺化呈現的緊湊聚類表明數據分布均衡，不存在明顯的異常樣本。

### 批次大小評估

- **當前批次大小合適**：非常低的GNS值表明當前批次大小設置提供了穩定的梯度估計。
- **考慮嘗試更小批次**：若追求更好的泛化性能，可考慮適當減小批次大小，引入更多隨機性。

### 訓練穩定性

- **健康的訓練過程**：GNS值雖有小幅波動但始終保持極低水平，表明訓練過程非常穩定。
- **適當的學習率**：穩定的梯度行為表明當前學習率設置適當，不需要調整。

### 後續建議

1. **嘗試更小的批次大小**：考慮將批次大小減半，觀察模型泛化性能是否提升。
2. **考慮增加訓練輪數**：當前訓練過程健康，可以考慮延長訓練時間，進一步提升性能。
3. **進行其他頻率的對比分析**：與500Hz和1000Hz的結果進行對比，了解不同頻率下梯度行為的差異。
4. **不同材質的交叉驗證**：對不同材質執行相同的分析，評估模型在不同材質上的適應性。

## 參考資料

1. Keskar, N. S., et al. (2016). On large-batch training for deep learning: Generalization gap and sharp minima.
2. Zhang, J., et al. (2019). Why gradient clipping accelerates training: A theoretical justification for adaptivity.
3. Bottou, L., & Bousquet, O. (2008). The tradeoffs of large scale learning. 